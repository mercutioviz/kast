# NGINX Reverse Proxy Configuration for OWASP ZAP
# 
# Purpose: Prevents ZAP proxy loop issues by providing port differentiation
# between API requests (external :8080) and internal ZAP daemon (:8081)
#
# Architecture:
#   Client :8080 → NGINX → ZAP :8081
#
# This configuration file is used by:
# - kast/scripts/launch-zap.sh (for manual/remote ZAP instances)
# - kast/terraform/*/main.tf (for cloud-deployed ZAP instances)
#
# Installation:
#   sudo cp zap-proxy.conf /etc/nginx/sites-available/
#   sudo ln -sf /etc/nginx/sites-available/zap-proxy /etc/nginx/sites-enabled/
#   sudo rm -f /etc/nginx/sites-enabled/default
#   sudo nginx -t && sudo systemctl restart nginx

server {
    listen 8080;
    server_name _;

    # Logging (optional - disable for production if needed)
    access_log /var/log/nginx/zap-access.log;
    error_log /var/log/nginx/zap-error.log;

    location / {
        # Proxy to ZAP on internal port
        proxy_pass http://localhost:8081;

        # Force HTTP/1.1 for better compatibility
        proxy_http_version 1.1;

        # Clear connection header to prevent connection reuse issues
        proxy_set_header Connection "";

        # CRITICAL: Rewrite Host header with port to avoid ZAP proxy loop
        # ZAP requires the port number to distinguish API requests from proxy requests
        # Without this, ZAP may treat API calls as proxy requests, causing failures
        proxy_set_header Host localhost:8081;

        # Make requests appear strictly local to ZAP
        # This prevents ZAP from treating external IPs as proxy targets
        proxy_set_header X-Real-IP 127.0.0.1;
        proxy_set_header X-Forwarded-For 127.0.0.1;
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header X-Forwarded-Host localhost;

        # Increase timeouts for long-running ZAP operations
        # ZAP scans can take minutes to hours depending on target complexity
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Allow large request bodies for scan configurations and file uploads
        client_max_body_size 10M;

        # Disable buffering for better streaming of scan progress
        # This allows real-time progress updates via ZAP API
        proxy_buffering off;
        proxy_request_buffering off;
    }
}
