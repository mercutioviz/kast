<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KAST Scan Report{% if target %} - {{ target }}{% endif %}</title>
    <link rel="stylesheet" href="kast_style.css">
    {% if not pdf_mode %}
    <style>
        /* Quick test background: only set the image so you can see the raw result */
        body { background-image: url('../assets/background.png'); }
    </style>
    {% endif %}
</head>
<body>
    <!-- Header with Logo and Metadata -->
    <div class="report-header">
        <div class="header-content">
            <div class="logo-section">
                {% if pdf_mode and logo_base64 %}
                <img src="{{ logo_base64 }}" alt="KAST Logo" class="kast-logo">
                {% elif custom_logo %}
                <img src="{{ custom_logo }}" alt="KAST Logo" class="kast-logo">
                {% else %}
                <img src="../assets/kast-logo.png" alt="KAST Logo" class="kast-logo">
                {% endif %}
                <div class="title-section">
                    <h1>KAST Security Scan Report</h1>
                    {% if target %}
                    <div class="target-badge">
                        <span class="target-icon">üéØ</span>
                        <span class="target-url">{{ target }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="metadata-box">
                <div class="metadata-item">
                    <span class="metadata-label">Scan Date:</span>
                    <span class="metadata-value">{{ scan_metadata.scan_date }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Total Issues:</span>
                    <span class="metadata-value">{{ scan_metadata.total_issues }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Plugins Run:</span>
                    <span class="metadata-value">{{ scan_metadata.total_plugins }}</span>
                </div>
            </div>
        </div>
    </div>

    <h2><span class="section-icon">üõ°Ô∏è</span> Executive Summary</h2>
    {% if plugin_executive_summaries %}
    <h4>Scan Findings</h4>
    {% for plugin_summary in plugin_executive_summaries %}
    <div class="plugin-executive-summary">
        
        {{ plugin_summary.summary|safe }}
    </div>
    {% endfor %}
    {% endif %}
    
    <h4>Potential Issues</h4>
    {{ executive_summary|safe }}

    <!-- WAF Impact Analysis Section -->
    {% if scan_metadata.waf_statistics.total_issues > 0 %}
    <div class="waf-impact-section">
        <h2><span class="section-icon">üõ°Ô∏è</span> WAF Impact Analysis</h2>
        
        <div class="waf-stats-grid">
            <div class="waf-stat-card waf-addressable">
                <div class="stat-icon">‚úì</div>
                <div class="stat-content">
                    <div class="stat-number">{{ scan_metadata.waf_statistics.waf_addressable_count }}</div>
                    <div class="stat-label">Issues Addressable by WAF</div>
                    <div class="stat-percentage">{{ scan_metadata.waf_statistics.waf_addressable_count }} of {{ scan_metadata.waf_statistics.total_issues }} ({{ scan_metadata.waf_statistics.waf_addressable_percentage }}%)</div>
                </div>
            </div>
            
            <div class="waf-stat-card waf-high">
                <div class="stat-icon">üî¥</div>
                <div class="stat-content">
                    <div class="stat-number">{{ scan_metadata.waf_statistics.high_severity_waf }}</div>
                    <div class="stat-label">High Severity (WAF)</div>
                    <div class="stat-sublabel">Immediate protection available</div>
                </div>
            </div>
            
            <div class="waf-stat-card waf-deployment">
                <div class="stat-icon">‚ö°</div>
                <div class="stat-content">
                    <div class="stat-number">1-2</div>
                    <div class="stat-label">Days to Deploy WAF</div>
                    <div class="stat-sublabel">vs 4-6 weeks for code fixes</div>
                </div>
            </div>
            
            <div class="waf-stat-card waf-coverage">
                <div class="stat-icon">üéØ</div>
                <div class="stat-content">
                    <div class="stat-number">{{ scan_metadata.waf_statistics.waf_addressable_percentage }}%</div>
                    <div class="stat-label">Risk Reduction</div>
                    <div class="stat-sublabel">With immediate WAF deployment</div>
                </div>
            </div>
        </div>
        
        <div class="waf-benefits-callout">
            <h3>üéØ Why Deploy a Web Application Firewall?</h3>
            <div class="benefit-grid">
                <div class="benefit-card">
                    <div class="benefit-header">
                        <span class="benefit-icon">‚ö°</span>
                        <h4>Immediate Protection</h4>
                    </div>
                    <p>Deploy in 1-2 days versus weeks of development time for code-level fixes</p>
                </div>
                
                <div class="benefit-card">
                    <div class="benefit-header">
                        <span class="benefit-icon">üõ°Ô∏è</span>
                        <h4>Defense in Depth</h4>
                    </div>
                    <p>Add an additional security layer while code updates are being developed and tested</p>
                </div>
                
                <div class="benefit-card">
                    <div class="benefit-header">
                        <span class="benefit-icon">üîí</span>
                        <h4>Header Injection</h4>
                    </div>
                    <p>Automatically inject missing security headers (CSP, HSTS, X-Frame-Options) without code changes</p>
                </div>
                
                <div class="benefit-card">
                    <div class="benefit-header">
                        <span class="benefit-icon">üìä</span>
                        <h4>Traffic Intelligence</h4>
                    </div>
                    <p>Monitor and analyze attack patterns to identify threats before they reach your application</p>
                </div>
                
                <div class="benefit-card">
                    <div class="benefit-header">
                        <span class="benefit-icon">üîß</span>
                        <h4>Virtual Patching</h4>
                    </div>
                    <p>Protect against known vulnerabilities while permanent fixes are being implemented</p>
                </div>
                
                <div class="benefit-card">
                    <div class="benefit-header">
                        <span class="benefit-icon">‚è±Ô∏è</span>
                        <h4>Reduced Time-to-Protection</h4>
                    </div>
                    <p>Close security gaps in days instead of the weeks or months required for code refactoring</p>
                </div>
            </div>
            
            <div class="recommendation-box">
                <strong>üí° Recommended Approach:</strong> Deploy a WAF immediately to address {{ scan_metadata.waf_statistics.waf_addressable_percentage }}% of identified issues, 
                then implement code-level fixes as a second layer of defense for comprehensive, long-term security.
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Issues Found Section with Integrated Severity Navigation -->
    <div class="issues-header-container">
        <h2><span class="section-icon">‚ö†Ô∏è</span> Issues Found</h2>
        <div id="severity-navigation" class="severity-badges">
            <a href="#high-issues" class="severity-badge severity-badge-high" style="text-decoration: none; color: inherit; cursor: pointer;">
                <span class="badge-icon">üî¥</span>
                <div class="badge-content">
                    <span class="badge-count">{{ scan_metadata.severity_counts.High }}</span>
                    <span class="badge-label">High</span>
                </div>
            </a>
            <a href="#medium-issues" class="severity-badge severity-badge-medium" style="text-decoration: none; color: inherit; cursor: pointer;">
                <span class="badge-icon">üü†</span>
                <div class="badge-content">
                    <span class="badge-count">{{ scan_metadata.severity_counts.Medium }}</span>
                    <span class="badge-label">Medium</span>
                </div>
            </a>
            <a href="#low-issues" class="severity-badge severity-badge-low" style="text-decoration: none; color: inherit; cursor: pointer;">
                <span class="badge-icon">üü°</span>
                <div class="badge-content">
                    <span class="badge-count">{{ scan_metadata.severity_counts.Low }}</span>
                    <span class="badge-label">Low</span>
                </div>
            </a>
            <a href="#info-issues" class="severity-badge severity-badge-info" style="text-decoration: none; color: inherit; cursor: pointer;">
                <span class="badge-icon">üîµ</span>
                <div class="badge-content">
                    <span class="badge-count">{{ scan_metadata.severity_counts.Info }}</span>
                    <span class="badge-label">Info</span>
                </div>
            </a>
        </div>
    </div>

    {% set severity_levels = ['High', 'Medium', 'Low', 'Info'] %}
    {% for severity in severity_levels %}
        {% set severity_issues = issues | selectattr('severity', 'equalto', severity) | list %}
        {% if severity_issues %}
        <h3 id="{{ severity|lower }}-issues" style="margin-top: 1.5em; color: #1e40af;">{{ severity }} Severity Issues</h3>
        {% for issue in severity_issues %}
        <div class="issue severity-{{ issue.severity|lower }}">
            <strong>{{ issue.display_name if issue.display_name else issue.id }}</strong> ({{ issue.severity }}, {{ issue.category }})<br>
        <em>Reported by: {{ issue.reported_by }} (issue id: {{ issue.id }})</em><br>
        <span>Remediation: {{ issue.remediation }}</span>
        </div>
        {% endfor %}
        {% endif %}
    {% endfor %}

    <h2><span class="section-icon">üîç</span> Detailed Results by Tool</h2>
    {% for tool, result in detailed_results.items() %}
    <div class="tool-section" id="tool-{{ tool|lower|replace(' ', '-')|replace('.', '-') }}">
        <h3>
        {% if result.website_url %}
            <a href="{{ result.website_url }}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">
                {{ result.display_name if result.display_name else tool }}
            </a>
        {% else %}
            {{ result.display_name if result.display_name else tool }}
        {% endif %}
        </h3>
        <p><strong>Purpose:</strong> {{ result.purpose }}</p>
        <p><strong>Summary:</strong> {{ result.summary|safe }}</p>
        <div>
            <button class="details-toggle" type="button" onclick="toggleDetails(this)">Show details</button>
            <div class="details-collapsible" style="display:none; margin-top:0.5em;">
                <div><strong>Timestamp:</strong> {{ result.timestamp }}</div>
                <div><strong>Disposition:</strong> {{ result.disposition }}</div>
                {% if result.details %}
                <div><strong>Details:</strong> {{ result.details|safe }}</div>
                {% endif %}
                <div><strong>Results:</strong>
                    {% if result.results_message %}
                    <div style="padding: 0.5em 0; color: #075985; font-weight: 500;">{{ result.results_message }}</div>
                    {% elif pdf_mode and result.results_html %}
                    <div class="json-display">{{ result.results_html|safe }}</div>
                    {% elif result.results %}
                    <div class="tree-json" data-json='{{ result.results | tojson }}'></div>
                    {% else %}
                    <div style="padding: 0.5em 0; color: #6b7280; font-style: italic;">No results data available</div>
                    {% endif %}
                </div>
                {% if result.custom_html %}
                <div class="custom-html-section" style="margin-top: 1em;">
                {{ result.custom_html|safe }}
                </div>
                {% endif %}
                <button class="raw-toggle" type="button" onclick="toggleRaw(this)">Show raw JSON</button>
                <pre class="raw-collapsible" style="display:none; background:#f4f4f4; border:1px solid #e0e0e0; border-radius:4px; padding:0.5em; max-height:400px; overflow:auto;">{{ result.findings | tojson(indent=2) }}</pre>
            </div>
        </div>
        <p></p><p><strong>Report Notes:</strong> {{ result.report|safe }}</p>
    </div>
    {% endfor %}

    <script>
    function toggleDetails(btn) {
        var section = btn.nextElementSibling;
        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.textContent = 'Hide details';
        } else {
            section.style.display = 'none';
            btn.textContent = 'Show details';
        }
    }
    function toggleRaw(btn) {
        var pre = btn.nextElementSibling;
        if (pre.style.display === 'none') {
            pre.style.display = 'block';
            btn.textContent = 'Hide raw JSON';
        } else {
            pre.style.display = 'none';
            btn.textContent = 'Show raw JSON';
        }
    }
    
    // URL Display Widget Functions
    function toggleUrlGroup(groupId) {
        var content = document.getElementById(groupId + '-content');
        var header = document.querySelector('[data-group="' + groupId + '"] .url-group-toggle');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            header.textContent = '‚ñ≤';
        } else {
            content.style.display = 'none';
            header.textContent = '‚ñº';
        }
    }
    
    function changeUrlPage(groupId, direction) {
        var list = document.getElementById(groupId + '-list');
        var currentPageSpan = document.getElementById(groupId + '-current-page');
        var currentPage = parseInt(currentPageSpan.textContent);
        var items = list.querySelectorAll('.url-item');
        
        // Calculate total pages
        var totalPages = 0;
        items.forEach(function(item) {
            var page = parseInt(item.getAttribute('data-page'));
            if (page > totalPages) totalPages = page;
        });
        
        // Calculate new page
        var newPage = currentPage + direction;
        if (newPage < 1) newPage = 1;
        if (newPage > totalPages) newPage = totalPages;
        
        // Update display
        items.forEach(function(item) {
            var itemPage = parseInt(item.getAttribute('data-page'));
            if (itemPage === newPage) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        
        currentPageSpan.textContent = newPage;
    }
    
    function filterKatanaUrls(widgetId) {
        var widget = document.getElementById(widgetId);
        var input = widget.querySelector('.url-search-input');
        var filter = input.value.toLowerCase();
        var groups = widget.querySelectorAll('.url-group');
        var totalVisible = 0;
        
        groups.forEach(function(group) {
            var items = group.querySelectorAll('.url-item');
            var visibleInGroup = 0;
            
            items.forEach(function(item) {
                var url = item.getAttribute('data-url');
                if (url.indexOf(filter) > -1) {
                    item.style.display = 'block';
                    visibleInGroup++;
                    totalVisible++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Hide group if no matches
            if (visibleInGroup === 0) {
                group.style.display = 'none';
            } else {
                group.style.display = 'block';
            }
            
            // Reset pagination when filtering
            if (filter) {
                var pagination = group.querySelector('.url-pagination');
                if (pagination) {
                    pagination.style.display = 'none';
                }
            } else {
                var pagination = group.querySelector('.url-pagination');
                if (pagination) {
                    pagination.style.display = 'flex';
                }
                // Reset to page 1 when clearing filter
                var groupId = group.getAttribute('data-group');
                var currentPageSpan = document.getElementById(groupId + '-current-page');
                if (currentPageSpan) {
                    currentPageSpan.textContent = '1';
                    // Show only page 1 items
                    items.forEach(function(item) {
                        var itemPage = parseInt(item.getAttribute('data-page'));
                        item.style.display = (itemPage === 1) ? 'block' : 'none';
                    });
                }
            }
        });
        
        // Update count badge
        var badge = widget.querySelector('.url-count-badge');
        if (filter) {
            badge.textContent = 'Showing: ' + totalVisible + ' URLs';
        } else {
            var allItems = widget.querySelectorAll('.url-item');
            badge.textContent = 'Total: ' + allItems.length + ' URLs';
        }
    }
    
    // FTAP Panel Functions
    function toggleFtapPanel(panelId) {
        var content = document.getElementById(panelId + '-content');
        var panel = document.querySelector('[data-panel-id="' + panelId + '"]');
        var toggle = panel.querySelector('.ftap-panel-toggle');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.textContent = '‚ñº';
        } else {
            content.style.display = 'none';
            toggle.textContent = '‚ñ∂';
        }
    }
    
    function toggleFtapRawJson(widgetId) {
        var jsonDiv = document.getElementById(widgetId + '-raw-json');
        var button = document.querySelector('[onclick*="toggleFtapRawJson(\'' + widgetId + '\')"]');
        
        if (jsonDiv.style.display === 'none') {
            jsonDiv.style.display = 'block';
            button.textContent = 'üìã Hide Raw JSON';
        } else {
            jsonDiv.style.display = 'none';
            button.textContent = 'üìã Show Raw JSON';
        }
    }
    
    function filterFtapPanels(widgetId) {
        var widget = document.getElementById(widgetId);
        var input = widget.querySelector('.url-search-input');
        var filter = input.value.toLowerCase();
        var groups = widget.querySelectorAll('.url-group');
        var totalVisible = 0;
        
        groups.forEach(function(group) {
            var panels = group.querySelectorAll('.ftap-panel');
            var visibleInGroup = 0;
            
            panels.forEach(function(panel) {
                var searchText = panel.getAttribute('data-search');
                if (searchText && searchText.indexOf(filter) > -1) {
                    panel.style.display = 'block';
                    visibleInGroup++;
                    totalVisible++;
                } else {
                    panel.style.display = 'none';
                }
            });
            
            // Hide group if no matches
            if (visibleInGroup === 0) {
                group.style.display = 'none';
            } else {
                group.style.display = 'block';
            }
        });
        
        // Update count badge
        var badge = widget.querySelector('.url-count-badge');
        if (filter) {
            badge.textContent = 'Showing: ' + totalVisible + ' Panel(s)';
        } else {
            var allPanels = widget.querySelectorAll('.ftap-panel');
            badge.textContent = 'Total: ' + allPanels.length + ' Panel(s)';
        }
    }
    </script>
    <!-- Tree-view CSS moved to kast_style.css -->
    <script>
    function toggleTreeNode(el) {
        var parent = el.parentNode;
        parent.classList.toggle('tree-collapsed');
        el.textContent = parent.classList.contains('tree-collapsed') ? '[+]' : '[-]';
    }
    function renderTree(obj) {
        function createNode(key, value, depth) {
            var type = typeof value;
            if (value && type === 'object') {
                var isArray = Array.isArray(value);
                var node = document.createElement('div');
                node.className = 'tree-node';
                var toggle = document.createElement('span');
                toggle.className = 'tree-toggle';
                toggle.onclick = function() { toggleTreeNode(toggle); };
                node.appendChild(toggle);
                var keySpan = document.createElement('span');
                keySpan.className = 'tree-key';
                keySpan.textContent = key + (isArray ? ' [ ]' : '');
                node.appendChild(keySpan);
                var children = document.createElement('div');
                children.className = 'tree-children';
                for (var k in value) {
                    if (Object.prototype.hasOwnProperty.call(value, k)) {
                        children.appendChild(createNode(k, value[k], depth + 1));
                    }
                }
                node.appendChild(children);
                // Collapse nodes deeper than top-level by default and set initial toggle symbol
                if (depth > 0) {
                    node.classList.add('tree-collapsed');
                    toggle.textContent = '[+]';
                } else {
                    toggle.textContent = '[-]';
                }
                return node;
            } else {
                var leaf = document.createElement('div');
                leaf.className = 'tree-leaf';
                leaf.innerHTML = '<span class="tree-key">' + key + ':</span> ' + escapeHtml(String(value));
                return leaf;
            }
        }
        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, function(c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c];
            });
        }
        var root = document.createElement('div');
        root.className = 'tree-view';
        if (obj && typeof obj === 'object') {
            for (var k in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, k)) {
                    root.appendChild(createNode(k, obj[k], 0));
                }
            }
        } else {
            root.textContent = String(obj);
        }
        return root;
    }
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.tree-json').forEach(function(el) {
            var data = el.getAttribute('data-json');
            if (data) {
                try {
                    var obj = JSON.parse(data);
                    var tree = renderTree(obj);
                    el.appendChild(tree);
                } catch (e) {
                    el.textContent = 'Error rendering tree: ' + e;
                }
            }
        });
    });
    </script>

    <!-- Footer -->
    <footer class="report-footer">
        <div class="footer-content">
            <div class="footer-left">
                {% if pdf_mode and logo_base64 %}
                <img src="{{ logo_base64 }}" alt="KAST" class="footer-logo">
                {% elif custom_logo %}
                <img src="{{ custom_logo }}" alt="KAST" class="footer-logo">
                {% else %}
                <img src="../assets/kast-logo.png" alt="KAST" class="footer-logo">
                {% endif %}
                <span class="footer-text">KAST Security Scanner</span>
            </div>
            <div class="footer-right">
                <span class="footer-text">Generated on {{ scan_metadata.scan_date }}</span>
            </div>
        </div>
    </footer>
</body>
</html>
