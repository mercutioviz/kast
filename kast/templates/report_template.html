<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KAST Scan Report{% if target %} - {{ target }}{% endif %}</title>
    <link rel="stylesheet" href="kast_style.css">
    {% if not pdf_mode %}
    <style>
        /* Quick test background: only set the image so you can see the raw result */
        body { background-image: url('../assets/background.png'); }
    </style>
    {% endif %}
</head>
<body>
    <!-- Header with Logo and Metadata -->
    <div class="report-header">
        <div class="header-content">
            <div class="logo-section">
                {% if pdf_mode and logo_base64 %}
                <img src="{{ logo_base64 }}" alt="KAST Logo" class="kast-logo">
                {% else %}
                <img src="../assets/kast-logo.png" alt="KAST Logo" class="kast-logo">
                {% endif %}
                <div class="title-section">
                    <h1>KAST Security Scan Report</h1>
                    {% if target %}
                    <div class="target-badge">
                        <span class="target-icon">üéØ</span>
                        <span class="target-url">{{ target }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="metadata-box">
                <div class="metadata-item">
                    <span class="metadata-label">Scan Date:</span>
                    <span class="metadata-value">{{ scan_metadata.scan_date }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Total Issues:</span>
                    <span class="metadata-value">{{ scan_metadata.total_issues }}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Plugins Run:</span>
                    <span class="metadata-value">{{ scan_metadata.total_plugins }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Severity Summary Badges -->
    <div class="severity-badges">
        <div class="severity-badge severity-badge-high">
            <span class="badge-icon">üî¥</span>
            <div class="badge-content">
                <span class="badge-count">{{ scan_metadata.severity_counts.High }}</span>
                <span class="badge-label">High</span>
            </div>
        </div>
        <div class="severity-badge severity-badge-medium">
            <span class="badge-icon">üü†</span>
            <div class="badge-content">
                <span class="badge-count">{{ scan_metadata.severity_counts.Medium }}</span>
                <span class="badge-label">Medium</span>
            </div>
        </div>
        <div class="severity-badge severity-badge-low">
            <span class="badge-icon">üü°</span>
            <div class="badge-content">
                <span class="badge-count">{{ scan_metadata.severity_counts.Low }}</span>
                <span class="badge-label">Low</span>
            </div>
        </div>
        <div class="severity-badge severity-badge-info">
            <span class="badge-icon">üîµ</span>
            <div class="badge-content">
                <span class="badge-count">{{ scan_metadata.severity_counts.Info }}</span>
                <span class="badge-label">Info</span>
            </div>
        </div>
    </div>

    <h2><span class="section-icon">üõ°Ô∏è</span> Executive Summary</h2>
    {% if plugin_executive_summaries %}
    <h4>Scan Findings</h4>
    {% for plugin_summary in plugin_executive_summaries %}
    <div class="plugin-executive-summary">
        
        {{ plugin_summary.summary|safe }}
    </div>
    {% endfor %}
    {% endif %}
    
    <h4>Potential Issues</h4>
    {{ executive_summary|safe }}

    <h2><span class="section-icon">‚ö†Ô∏è</span> Issues Found</h2>
    {% for issue in issues %}
    <div class="issue severity-{{ issue.severity|lower }}">
        <strong>{{ issue.display_name if issue.display_name else issue.id }}</strong> ({{ issue.severity }}, {{ issue.category }})<br>
    <em>Reported by: {{ issue.reported_by }} (issue id: {{ issue.id }})</em><br>
    <span>Remediation: {{ issue.remediation }}</span>
    </div>
    {% endfor %}

    <h2><span class="section-icon">üîç</span> Detailed Results by Tool</h2>
    {% for tool, result in detailed_results.items() %}
    <div class="tool-section">
        <h3>
        {% if result.website_url %}
            <a href="{{ result.website_url }}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">
                {{ result.display_name if result.display_name else tool }}
            </a>
        {% else %}
            {{ result.display_name if result.display_name else tool }}
        {% endif %}
        </h3>
        <p><strong>Purpose:</strong> {{ result.purpose }}</p>
        <p><strong>Summary:</strong> {{ result.summary|safe }}</p>
        {% if result.custom_html %}
        <div class="custom-html-section">
        {{ result.custom_html|safe }}
        </div>
        {% endif %}
        <div>
            <button class="details-toggle" type="button" onclick="toggleDetails(this)">Show details</button>
            <div class="details-collapsible" style="display:none; margin-top:0.5em;">
                <div><strong>Timestamp:</strong> {{ result.timestamp }}</div>
                <div><strong>Disposition:</strong> {{ result.disposition }}</div>
                {% if result.details %}
                <div><strong>Details:</strong> {{ result.details|safe }}</div>
                {% endif %}
                <div><strong>Results:</strong>
                    {% if pdf_mode and result.results_html %}
                    <div class="json-display">{{ result.results_html|safe }}</div>
                    {% else %}
                    <div class="tree-json" data-json='{{ result.results | tojson }}'></div>
                    {% endif %}
                </div>
                <button class="raw-toggle" type="button" onclick="toggleRaw(this)">Show raw JSON</button>
                <pre class="raw-collapsible" style="display:none; background:#f4f4f4; border:1px solid #e0e0e0; border-radius:4px; padding:0.5em; max-height:400px; overflow:auto;">{{ result.findings | tojson(indent=2) }}</pre>
            </div>
        </div>
        <p></p><p><strong>Report Notes:</strong> {{ result.report|safe }}</p>
    </div>
    {% endfor %}

    <script>
    function toggleDetails(btn) {
        var section = btn.nextElementSibling;
        if (section.style.display === 'none') {
            section.style.display = 'block';
            btn.textContent = 'Hide details';
        } else {
            section.style.display = 'none';
            btn.textContent = 'Show details';
        }
    }
    function toggleRaw(btn) {
        var pre = btn.nextElementSibling;
        if (pre.style.display === 'none') {
            pre.style.display = 'block';
            btn.textContent = 'Hide raw JSON';
        } else {
            pre.style.display = 'none';
            btn.textContent = 'Show raw JSON';
        }
    }
    
    // URL Display Widget Functions
    function toggleUrlGroup(groupId) {
        var content = document.getElementById(groupId + '-content');
        var header = document.querySelector('[data-group="' + groupId + '"] .url-group-toggle');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            header.textContent = '‚ñ≤';
        } else {
            content.style.display = 'none';
            header.textContent = '‚ñº';
        }
    }
    
    function changeUrlPage(groupId, direction) {
        var list = document.getElementById(groupId + '-list');
        var currentPageSpan = document.getElementById(groupId + '-current-page');
        var currentPage = parseInt(currentPageSpan.textContent);
        var items = list.querySelectorAll('.url-item');
        
        // Calculate total pages
        var totalPages = 0;
        items.forEach(function(item) {
            var page = parseInt(item.getAttribute('data-page'));
            if (page > totalPages) totalPages = page;
        });
        
        // Calculate new page
        var newPage = currentPage + direction;
        if (newPage < 1) newPage = 1;
        if (newPage > totalPages) newPage = totalPages;
        
        // Update display
        items.forEach(function(item) {
            var itemPage = parseInt(item.getAttribute('data-page'));
            if (itemPage === newPage) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        
        currentPageSpan.textContent = newPage;
    }
    
    function filterKatanaUrls(widgetId) {
        var widget = document.getElementById(widgetId);
        var input = widget.querySelector('.url-search-input');
        var filter = input.value.toLowerCase();
        var groups = widget.querySelectorAll('.url-group');
        var totalVisible = 0;
        
        groups.forEach(function(group) {
            var items = group.querySelectorAll('.url-item');
            var visibleInGroup = 0;
            
            items.forEach(function(item) {
                var url = item.getAttribute('data-url');
                if (url.indexOf(filter) > -1) {
                    item.style.display = 'block';
                    visibleInGroup++;
                    totalVisible++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Hide group if no matches
            if (visibleInGroup === 0) {
                group.style.display = 'none';
            } else {
                group.style.display = 'block';
            }
            
            // Reset pagination when filtering
            if (filter) {
                var pagination = group.querySelector('.url-pagination');
                if (pagination) {
                    pagination.style.display = 'none';
                }
            } else {
                var pagination = group.querySelector('.url-pagination');
                if (pagination) {
                    pagination.style.display = 'flex';
                }
                // Reset to page 1 when clearing filter
                var groupId = group.getAttribute('data-group');
                var currentPageSpan = document.getElementById(groupId + '-current-page');
                if (currentPageSpan) {
                    currentPageSpan.textContent = '1';
                    // Show only page 1 items
                    items.forEach(function(item) {
                        var itemPage = parseInt(item.getAttribute('data-page'));
                        item.style.display = (itemPage === 1) ? 'block' : 'none';
                    });
                }
            }
        });
        
        // Update count badge
        var badge = widget.querySelector('.url-count-badge');
        if (filter) {
            badge.textContent = 'Showing: ' + totalVisible + ' URLs';
        } else {
            var allItems = widget.querySelectorAll('.url-item');
            badge.textContent = 'Total: ' + allItems.length + ' URLs';
        }
    }
    </script>
    <!-- Tree-view CSS moved to kast_style.css -->
    <script>
    function toggleTreeNode(el) {
        var parent = el.parentNode;
        parent.classList.toggle('tree-collapsed');
        el.textContent = parent.classList.contains('tree-collapsed') ? '[+]' : '[-]';
    }
    function renderTree(obj) {
        function createNode(key, value, depth) {
            var type = typeof value;
            if (value && type === 'object') {
                var isArray = Array.isArray(value);
                var node = document.createElement('div');
                node.className = 'tree-node';
                var toggle = document.createElement('span');
                toggle.className = 'tree-toggle';
                toggle.onclick = function() { toggleTreeNode(toggle); };
                node.appendChild(toggle);
                var keySpan = document.createElement('span');
                keySpan.className = 'tree-key';
                keySpan.textContent = key + (isArray ? ' [ ]' : '');
                node.appendChild(keySpan);
                var children = document.createElement('div');
                children.className = 'tree-children';
                for (var k in value) {
                    if (Object.prototype.hasOwnProperty.call(value, k)) {
                        children.appendChild(createNode(k, value[k], depth + 1));
                    }
                }
                node.appendChild(children);
                // Collapse nodes deeper than top-level by default and set initial toggle symbol
                if (depth > 0) {
                    node.classList.add('tree-collapsed');
                    toggle.textContent = '[+]';
                } else {
                    toggle.textContent = '[-]';
                }
                return node;
            } else {
                var leaf = document.createElement('div');
                leaf.className = 'tree-leaf';
                leaf.innerHTML = '<span class="tree-key">' + key + ':</span> ' + escapeHtml(String(value));
                return leaf;
            }
        }
        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, function(c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c];
            });
        }
        var root = document.createElement('div');
        root.className = 'tree-view';
        if (obj && typeof obj === 'object') {
            for (var k in obj) {
                if (Object.prototype.hasOwnProperty.call(obj, k)) {
                    root.appendChild(createNode(k, obj[k], 0));
                }
            }
        } else {
            root.textContent = String(obj);
        }
        return root;
    }
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.tree-json').forEach(function(el) {
            var data = el.getAttribute('data-json');
            if (data) {
                try {
                    var obj = JSON.parse(data);
                    var tree = renderTree(obj);
                    el.appendChild(tree);
                } catch (e) {
                    el.textContent = 'Error rendering tree: ' + e;
                }
            }
        });
    });
    </script>

    <!-- Footer -->
    <footer class="report-footer">
        <div class="footer-content">
            <div class="footer-left">
                {% if pdf_mode and logo_base64 %}
                <img src="{{ logo_base64 }}" alt="KAST" class="footer-logo">
                {% else %}
                <img src="../assets/kast-logo.png" alt="KAST" class="footer-logo">
                {% endif %}
                <span class="footer-text">KAST Security Scanner</span>
            </div>
            <div class="footer-right">
                <span class="footer-text">Generated on {{ scan_metadata.scan_date }}</span>
            </div>
        </div>
    </footer>
</body>
</html>
